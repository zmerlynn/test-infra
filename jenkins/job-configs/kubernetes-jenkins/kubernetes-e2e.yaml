# Common publishers shared by all e2e jobs.
- publisher:
    name: e2e-publishers
    publishers:
        - claim-build
        - junit-publisher
        - gcs-uploader
        - log-parser
        - email-ext:
            recipients: '{recipients}'

# Common attributes/actions shared by all e2e jobs.
- e2e_job_defaults: &e2e_job_defaults
    name: e2e_job_defaults
    description: '{description} Test owner: {test-owner}.'
    logrotate:
        daysToKeep: 7
    jenkins_node: 'e2e'
    disabled: '{obj:disable_job}'
    builders:
        - shell: |
            {provider-env}
            {job-env}
            {post-env}
            timeout -k {kill-timeout}m {timeout}m {runner} && rc=$? || rc=$?
            if [[ ${{rc}} -ne 0 ]]; then
                if [[ -x kubernetes/cluster/log-dump.sh && -d _artifacts ]]; then
                    echo "Dumping logs for any remaining nodes"
                    ./kubernetes/cluster/log-dump.sh _artifacts
                fi
            fi
            {report-rc}
    wrappers:
        - ansicolor:
            colormap: xterm
        - timeout:
            timeout: '{jenkins-timeout}'
            fail: true
        - timestamps
        - workspace-cleanup:
            dirmatch: true
            external-deletion-command: 'sudo rm -rf %s'

# Template for most e2e test jobs.
- job-template:
    name: 'kubernetes-e2e-{suffix}'
    <<: *e2e_job_defaults
    node: '{jenkins_node}'
    triggers:
        - reverse:
            jobs: '{trigger-job}'
            result: success
        - timed: '{cron-string}'
    publishers:
      - e2e-publishers:
          recipients: '{emails}'

- project:
    name: kubernetes-e2e-gce-master
    trigger-job: 'kubernetes-build'
    test-owner: 'Build Cop'
    provider-env: '{gce-provider-env}'
    suffix:
        - 'gce':
            cron-string: '{sq-cron-string}'
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE in parallel.'
            timeout: 50  # See #21138
            job-env: |
                # This is the *only* job that should publish the last green version.
                export E2E_PUBLISH_GREEN_VERSION="true"
                # This list should match the list in kubernetes-pull-build-test-e2e-gce.
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-jkns-e2e-gce"
        - 'gce-slow':
            cron-string: '{sq-cron-string}'
            description: 'Runs slow tests on GCE, sequentially.'
            timeout: 150  #  See #24072
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-jkns-e2e-gce-slow"
        - 'gce-serial':
            description: 'Run [Serial], [Disruptive], tests on GCE.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="kubernetes-jkns-e2e-gce-serial"
        - 'gce-reboot':
            description: 'Run [Feature:Reboot] tests on GCE.'
            timeout: 180
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Reboot\]"
                export PROJECT="k8s-jkns-e2e-gce-ci-reboot"
        - 'gce-autoscaling':
            description: 'Run autoscaling E2E tests on GCE.'
            timeout: 210
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:ClusterSizeAutoscaling\]|\[Feature:InitialResources\] \
                                         --ginkgo.skip=\[Flaky\]"
                export PROJECT="k8s-jnks-e2e-gce-autoscaling"
                # Override GCE default for cluster size autoscaling purposes.
                export ENABLE_CUSTOM_METRICS="true"
                export KUBE_ENABLE_NODE_AUTOSCALER="true"
                export NUM_NODES=3
                export KUBE_AUTOSCALER_MIN_NODES=3
                export KUBE_AUTOSCALER_MAX_NODES=5
                export KUBE_ADMISSION_CONTROL="NamespaceLifecycle,InitialResources,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota"
        - 'gce-flaky':
            description: 'Run the flaky tests on GCE, sequentially.'
            timeout: 180
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Flaky\] \
                                         --ginkgo.skip=\[Feature:.+\]"
                export PROJECT="k8s-jkns-e2e-gce-flaky"
        - 'gce-scalability':
            cron-string: '{sq-cron-string}'
            description: 'Run the performance/scalability tests on GCE. A larger cluster is used.'
            timeout: 120
            # TODO: Run this twice a day after we make kubemark-500 a blocking suite.
            # cron-string: 'H H/12 * * *'
            job-env: |
                export E2E_NAME="e2e-scalability"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Performance\] \
                                         --gather-resource-usage=true \
                                         --gather-metrics-at-teardown=true \
                                         --gather-logs-sizes=true \
                                         --output-print-type=json"
                # Create a project k8s-jenkins-scalability-head and move this test there
                export PROJECT="google.com:k8s-jenkins-scalability"
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
                # Override GCE defaults.
                export MASTER_SIZE="n1-standard-4"
                export NODE_SIZE="n1-standard-2"
                export NODE_DISK_SIZE="50GB"
                export NUM_NODES="100"
                export REGISTER_MASTER="true"
                # Reduce logs verbosity
                export TEST_CLUSTER_LOG_LEVEL="--v=2"
                # TODO: Remove when we figure out the reason for occasional failures #19048
                export KUBELET_TEST_LOG_LEVEL="--v=4"
                # Increase resync period to simulate production
                export TEST_CLUSTER_RESYNC_PERIOD="--min-resync-period=12h"
                # Increase delete collection parallelism
                export TEST_CLUSTER_DELETE_COLLECTION_WORKERS="--delete-collection-workers=16"
        - 'gce-container-vm':
            cron-string: '{sq-cron-string}'
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE in parallel on a new ContainerVM image.'
            timeout: 50  # See #21138
            job-env: |
                # This list should match the list in kubernetes-pull-build-test-e2e-gce.
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-jenkins-cvm"
                export KUBE_GCE_MASTER_IMAGE="container-v1-3-v20160517"
        - 'gce-proto':
            cron-string: '{sq-cron-string}'
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE in parallel with protobuf communication.'
            timeout: 50  # See #21138
            job-env: |
                # This list should match the list in kubernetes-pull-build-test-e2e-gce.
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\] \
                                         --kube-api-content-type=application/vnd.kubernetes.protobuf"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-jkns-e2e-protobuf"
                # Store protobufs in database.
                export TEST_CLUSTER_STORAGE_CONTENT_TYPE="--storage-media-type=application/vnd.kubernetes.protobuf"
                # Use protobufs to communicate with apiserver.
                export TEST_CLUSTER_API_CONTENT_TYPE="--kube-api-content-type=application/vnd.kubernetes.protobuf"
        - 'gce-examples':
            description: 'Run E2E examples test on GCE.'
            timeout: 90
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Example\]"
                export PROJECT="k8s-jkns-e2e-examples"
        - 'gce-ubernetes-lite':
            description: 'Run all non-flaky, non-slow, non-disruptive, non-feature tests on GCE, in parallel, and in a multi-zone (Ubernetes-lite) cluster.'
            timeout: 150
            emails: 'quinton@google.com, justin@fathomdb.com'
            test-owner: 'quinton'
            job-env: |
                export PROJECT="k8s-jkns-e2e-gce-ubelite"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export MULTIZONE="true"
                export E2E_ZONES="us-central1-a us-central1-b us-central1-f" # Where the nodes reside.  Master is in the first one.
                export KUBE_GCE_ZONE="us-central1-a" # Where the master resides - hangover due to legacy scripts.
        - 'gce-kubenet':
            description: 'Run all non-flaky, non-slow, non-disruptive, non-feature tests on GCE using kubenet as network provider'
            timeout: 120
            emails: 'mixia@google.com'
            test-owner: 'mixia'
            job-env: |
                export PROJECT="k8s-jkns-e2e-gce-kubenet"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export NETWORK_PROVIDER="kubenet"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-gke-master
    trigger-job: 'kubernetes-build'
    test-owner: 'Build Cop'
    provider-env: '{gke-provider-env}'
    suffix:
        - 'gke':
            cron-string: '{sq-cron-string}'
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GKE in parallel (against GKE test endpoint)'
            timeout: 50  # See #21138
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-ci"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
        - 'gke-slow':
            cron-string: '{sq-cron-string}'
            description: 'Run slow E2E tests on GKE using the latest successful build.'
            timeout: 150  #  See #24072
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-slow"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
        - 'gke-serial':
            description: 'Run [Serial], [Disruptive] tests on GKE.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="jenkins-gke-e2e-serial"
        - 'gke-reboot':
            description: 'Run [Feature:Reboot] tests on GKE using the latest successful build.'
            timeout: 180
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-ci-reboot"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Reboot\]"
        - 'gke-flaky':
            description: |
                Run flaky e2e tests using the following config:<br>
                - provider: GKE<br>
                - api proxy: staging<br>
                - borg job: test<br>
                - client (kubectl): ci/latest.txt<br>
                - cluster (k8s): ci/latest.txt<br>
                - tests: ci/latest.txt
            timeout: 300
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-ci-flaky"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Flaky\] \
                                         --ginkgo.skip=\[Feature:.+\]"
        - 'gke-multizone':
            description: 'Run all non-flaky, non-slow, non-disruptive, non-feature tests on GKE, in parallel, and in a multi-zone (Ubernetes-lite) cluster.'
            timeout: 150
            emails: 'arob@google.com, quinton@google.com'
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-multizone"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export ZONE="us-central1-f"
                export ADDITIONAL_ZONES="us-central1-a,us-central1-b"
        - 'gke-large-cluster':
            description: 'Run all non-flaky, non-slow, non-disruptive, non-feature tests on GKE, in parallel on a large (1000 node) GKE cluster'
            timeout: 300
            emails: 'zml@google.com'
            cron-string: ''
            trigger-job: ''
            # TODO(zmerlynn) change back to PROJECT="gke-large-cluster-jenkins", re-enable Heapster
            job-env: |
                export PROJECT="kubernetes-scale"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export ZONE="us-east1-a"
                export NUM_NODES=2000
                export MACHINE_TYPE="n1-standard-1"
                export ALLOWED_NOTREADY_NODES="10"
                export CLUSTER_IP_RANGE="10.8.0.0/13"
                export GKE_CREATE_FLAGS="--max-nodes-per-pool=100 --no-enable-cloud-monitoring --disable-addons HorizontalPodAutoscaling"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-gce-1-2
    trigger-job: 'kubernetes-build-1.2'
    test-owner: 'Build Cop'
    provider-env: |
        {gce-provider-env}
        export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
    suffix:
        - 'gce-release-1.2':
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE in parallel on the release-1.2 branch.'
            timeout: 50  # See #21138
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-jkns-e2e-gce-1-2"
        - 'gce-reboot-release-1.2':
            description: 'Run [Feature:Reboot] tests on GCE on the release-1.2 branch.'
            timeout: 180
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Reboot\]"
                export PROJECT="k8s-jkns-e2e-gce-reboot-1-2"
        - 'gce-slow-release-1.2':
            description: 'Runs slow tests on GCE, sequentially on the release-1.2 branch.'
            timeout: 60
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-jkns-e2e-gce-slow-1-2"
        - 'gce-serial-release-1.2':
            description: 'Run [Serial], [Disruptive], tests on GCE on the release-1.2 branch.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="k8s-jkns-e2e-gce-serial-1-2"
        - 'gce-ingress-release-1.2':
            description: 'Run [Feature:Ingress] tests on GCE on the release-1.2 branch.'
            timeout: 90
            emails: 'beeps@google.com'
            test-owner: 'beeps'
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Ingress\]"
                export PROJECT="kubernetes-ingress-1-2"
                # TODO: Enable this when we've split 1.2 tests into another project.
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
        - 'gce-scalability-release-1.2':
            timeout: 120
            description: 'Run scalability E2E tests on GCE from the release-1.2 branch.'
            # Run on Saturday 8 am
            cron-string: 'H 8 * * 6'
            job-env: |
                export E2E_NAME="e2e-scalability-1-2"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Performance\] \
                                         --gather-resource-usage=true \
                                         --gather-metrics-at-teardown=true \
                                         --gather-logs-sizes=true \
                                         --output-print-type=json"
                # Use the 1.1 project for now, since it has quota.
                # TODO: create a project k8s-e2e-gce-scalability-release and move this test there
                export PROJECT="k8s-e2e-gce-scalability-1-1"
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
                # Override GCE defaults.
                export KUBE_GCE_ZONE="us-east1-b"
                export MASTER_SIZE="n1-standard-4"
                export NODE_SIZE="n1-standard-1"
                export NODE_DISK_SIZE="50GB"
                export NUM_NODES="100"
                export REGISTER_MASTER="true"
                # Reduce logs verbosity
                export TEST_CLUSTER_LOG_LEVEL="--v=2"
                # TODO: Remove when we figure out the reason for occasional failures #19048
                export KUBELET_TEST_LOG_LEVEL="--v=4"
                # Increase resync period to simulate production
                export TEST_CLUSTER_RESYNC_PERIOD="--min-resync-period=12h"
                # Increase delete collection parallelism
                export TEST_CLUSTER_DELETE_COLLECTION_WORKERS="--delete-collection-workers=16"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-gke-1-2
    trigger-job: 'kubernetes-build-1.2'
    test-owner: 'Build Cop'
    provider-env: |
        {gke-provider-env}
        export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
    suffix:
        - 'gke-release-1.2':
            description: 'Run E2E tests on GKE from the release-1.2 branch.'
            timeout: 50  # See #21138
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-1-2"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
        - 'gke-serial-release-1.2':
            description: 'Run [Serial], [Disruptive] tests on GKE on the release-1.2 branch.'
            timeout: 300
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-serial-1-2"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
        - 'gke-slow-release-1.2':
            description: 'Run slow E2E tests on GKE using the release-1.2 branch.'
            timeout: 60
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-slow-1-2"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
        - 'gke-ingress-release-1.2':
            description: 'Run [Feature:Ingress] tests on GKE on the release-1.2 branch.'
            timeout: 90
            emails: 'beeps@google.com'
            test-owner: 'beeps'
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Ingress\]"
                export PROJECT="kubernetes-gke-ingress-1-2"
                # TODO: Enable this when we've split 1.2 tests into another project.
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-gke-version-pinned
    # TODO(spxtr) This should float with the current release, or something.
    trigger-job: 'kubernetes-build-1.2'
    test-owner: 'GKE on-call'
    provider-env: |
        {gke-provider-env}
    suffix:
        - 'gke-pre-release':
            description: 'Run E2E tests on GKE test endpoint against the latest prerelease (alpha/beta).'
            timeout: 480
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-prerel"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_PUBLISHED_VERSION="release/latest"
        - 'gke-test':
            description: 'Run E2E tests on GKE test endpoint.'
            timeout: 480
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-test"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
        - 'gke-subnet':
            description: 'Run E2E tests on GKE test endpoint in a subnet.'
            timeout: 480
            job-env: |
                # auto-subnet manually created - if deleted, it will need to be recreated
                # gcloud alpha compute networks create auto-subnet --mode auto
                export E2E_NAME="auto-subnet"
                export PROJECT="k8s-jkns-e2e-gke-subnet"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
        - 'gke-staging':
            description: 'Run E2E tests on GKE staging endpoint.'
            timeout: 480
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-staging"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER="https://staging-container.sandbox.googleapis.com/"
        - 'gke-staging-parallel':
            description: 'Run E2E tests on GKE staging endpoint in parallel.'
            timeout: 80
            job-env: |
                export PROJECT="k8s-e2e-gke-staging-parallel"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER="https://staging-container.sandbox.googleapis.com/"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
        - 'gke-prod':
            description: 'Run E2E tests on GKE prod endpoint.'
            timeout: 480
            job-env: |
                export PROJECT="k8s-jkns-e2e-gke-prod"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER="https://container.googleapis.com/"
                export ZONE="asia-east1-b"
        - 'gke-prod-parallel':
            description: 'Run E2E tests on GKE prod endpoint in parallel.'
            timeout: 80
            job-env: |
                export PROJECT="k8s-e2e-gke-prod-parallel"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER="https://container.googleapis.com/"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export ZONE="asia-east1-b"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-gke-1.1
    trigger-job: 'kubernetes-build-1.1'
    test-owner: 'Build Cop'
    branch: 'release-1.1'
    jenkins_node: 'master'
    runner: '{old-runner-1-1}'
    post-env: ''
    suffix:
        - 'gke-1.1':
            timeout: 150
            description: 'Run E2E tests on GKE from the 1.1 release branch.'
            cron-string: 'H */6 * * *'
    jobs:
        - 'kubernetes-e2e-{suffix}'


- project:
    name: kubernetes-e2e-gce-1.1
    trigger-job: 'kubernetes-build-1.1'
    test-owner: 'Build Cop'
    branch: 'release-1.1'
    jenkins_node: 'master'
    runner: '{old-runner-1-1}'
    post-env: ''
    cron-string: 'H */6 * * *'
    suffix:
        - 'gce-release-1.1':
            timeout: 175
            description: 'Run E2E tests on GCE from the current release branch.'
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-1.0
    trigger-job: 'kubernetes-build-1.0'
    test-owner: 'Build Cop'
    branch: 'release-1.0'
    jenkins_node: 'master'
    runner: '{old-runner-1-0}'
    post-env: ''
    cron-string: 'H */12 * * *'
    suffix:
        - 'gce-release-1.0':
            timeout: 150
            description: 'Run E2E tests on GCE from the release-1.0 branch.'
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-features
    trigger-job: 'kubernetes-build'
    suffix:
        - 'gke-ingress':
            description: 'Run [Feature:Ingress] tests on GKE using the latest successful build.'
            timeout: 90
            emails: 'beeps@google.com'
            test-owner: 'beeps'
            provider-env: '{gke-provider-env}'
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Ingress\]"
                export PROJECT="kubernetes-gke-ingress"
                # TODO: Enable this when we've split 1.2 tests into another project.
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
        - 'gce-ingress':
            description: 'Run [Feature:Ingress] tests on GCE.'
            timeout: 90
            emails: 'beeps@google.com'
            test-owner: 'beeps'
            provider-env: '{gce-provider-env}'
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Ingress\]"
                export PROJECT="kubernetes-ingress"
                # TODO: Enable this when we've split 1.2 tests into another project.
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
        - 'gce-flannel':
            description: 'Run E2E tests on GCE using Flannel and the latest successful build. This suite is quarantined in a dedicated project because Flannel integration is experimental.'
            disable_job: true  # Issue #24520
            # We don't really care to enforce a timeout for flannel tests. Any performance issues will show up in the other GCE builders.
            # This suite is to continuously check that flannel + Kubernetes works.
            timeout: 120
            emails: 'beeps@google.com'
            test-owner: 'beeps'
            provider-env: '{gce-provider-env}'
            job-env: |
                # XXX Not a unique project
                export E2E_NAME="e2e-flannel"
                export PROJECT="kubernetes-flannel"
                export FAIL_ON_GCP_RESOURCE_LEAK="false"
                # Override GCE defaults.
                export NETWORK_PROVIDER="flannel"
        - 'gce-es-logging':
            description: 'Run [Feature:Elasticsearch] tests on GCE using the latest successful build.'
            timeout: 90
            emails: 'mixia@google.com'
            test-owner: 'mixia'
            provider-env: '{gce-provider-env}'
            job-env: |
                export PROJECT="kubernetes-es-logging"
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Elasticsearch\]"
                export KUBE_LOGGING_DESTINATION="elasticsearch"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-aws
    test-owner: 'bburns'
    emails: 'bburns@google.com'
    cron-string: '@daily'
    trigger-job: ''
    timeout: 240
    jenkins_node: 'master'
    runner: '{legacy-runner}'
    provider-env: |
        {aws-provider-env}
        export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
        export GINKGO_PARALLEL="y"
        export PROJECT="k8s-jkns-e2e-aws"
        export AWS_CONFIG_FILE='/var/lib/jenkins/.aws/credentials'
        export AWS_SSH_KEY='/var/lib/jenkins/.ssh/kube_aws_rsa'
        export KUBE_SSH_USER='admin'
        # This is needed to be able to create PD from the e2e test
        export AWS_SHARED_CREDENTIALS_FILE='/var/lib/jenkins/.aws/credentials'
    suffix:
        - 'aws':
            description: 'Run e2e tests on AWS using the latest successful Kubernetes build.'
            job-env: |
                export E2E_NAME="e2e-aws-master"
        - 'aws-release-1.2':
            description: 'Run e2e tests on AWS using the latest successful 1.2 Kubernetes build.'
            job-env: |
                export E2E_NAME="e2e-aws-1-2"
                export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
    jobs:
        - 'kubernetes-e2e-{suffix}'

- project:
    name: kubernetes-e2e-gce-enormous-cluster
    test-owner: 'gmarek'
    emails: 'gmarek@google.com'
    # Run only on Sunday and Wednesday at 8 am MTV time.
    cron-string: 'H 8 * * 0,4'
    trigger-job: ''
    description: 'Starts and deletes empty 1000 node cluster and runs Density 30 test on it. Does allow few Nodes to fail during startup.'
    timeout: 480
    branch: 'master'
    suffix: 'gce-enormous-cluster'
    provider-env: '{gce-provider-env}'
    job-env: |
        # XXX Not a unique project
        export E2E_NAME="e2e-enormous-cluster"
        export GINKGO_TEST_ARGS="--ginkgo.focus=\[Feature:Performance\]"
        export PROJECT="kubernetes-scale"
        export FAIL_ON_GCP_RESOURCE_LEAK="false"
        # Override GCE defaults.
        # Temporarily switch of Heapster, as this will not schedule anywhere.
        # TODO: Think of a solution to enable it.
        export CLUSTER_IP_RANGE="10.244.0.0/13"
        export KUBE_ENABLE_CLUSTER_MONITORING="none"
        export KUBE_GCE_ZONE="us-central1-c"
        export MASTER_SIZE="n1-standard-32"
        export NODE_SIZE="n1-standard-1"
        export NODE_DISK_SIZE="50GB"
        export NUM_NODES="1000"
        export ALLOWED_NOTREADY_NODES="2"
        # Reduce logs verbosity
        export TEST_CLUSTER_LOG_LEVEL="--v=1"
        export MAX_INSTANCES_PER_MIG="1000"
        # Increase resync period to simulate production
        export TEST_CLUSTER_RESYNC_PERIOD="--min-resync-period=12h"
        # Increase delete collection parallelism
        export TEST_CLUSTER_DELETE_COLLECTION_WORKERS="--delete-collection-workers=16"
    jobs:
        - 'kubernetes-e2e-{suffix}'

# NOTE: From here on all jobs use Trusty as the image for master and/or nodes.
# Please add templates/groups/projects/jobs that use ContainerVm above/below
# this section (search "End of Trusty jobs" for the ending separator).
#
# This section contains three types of jobs (all run e2e tests on GCE):
#   * Jobs that use a "green" Trusty image to test k8s continuous builds (hence
#     the "ci" in job names). We use these to guard k8s and Trusty
#     compatibility.
#   * Jobs that use a released k8s version to test Trusty's continuous builds
#     (dev, beta and stable). We use these to qualify Trusty image releases.
#   * Jobs that run tests against GKE endpoints with Trusty images. We use these
#     to soak Trusty release candidate before pushing to GKE production.

# e2e test jobs that run on GCE with a "green" Trusty image and kubernetes'
# continuous builds (currently only targeting `master` and `release-1.2`).
- job-template:
    name: 'kubernetes-e2e-gce-trusty-ci-{suffix}'
    <<: *e2e_job_defaults
    node: '{jenkins_node}'
    triggers:
        - reverse:
            jobs: '{trigger-job}'
            result: success
        - timed: '{cron-string}'
    publishers:
        - e2e-publishers:
            recipients: '{emails}'
        - description-setter:
            regexp: KUBE_GCE_MASTER_IMAGE=(.*)
        - groovy-postbuild:
            script: |
                def trustyImageMatcher = manager.getLogMatcher("KUBE_GCE_MASTER_IMAGE=(.*)")
                if(trustyImageMatcher?.matches()) manager.addShortText("<b>Trusty Image: " + trustyImageMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
                def k8sVersionMatcher = manager.getLogMatcher("Using\\spublished\\sversion\\s(.*)\\s\\(from.*")
                if(k8sVersionMatcher?.matches()) manager.addShortText("<br><b>Kubernetes version: " + k8sVersionMatcher.group(1) + "</b>", "grey", "white", "0px", "white")

- project:
    name: kubernetes-e2e-gce-trusty-ci-master
    trigger-job: 'kubernetes-build'
    test-owner: 'wonderfly@google.com'
    emails: 'wonderfly@google.com,qzheng@google.com'
    provider-env: |
        {gce-provider-env}
        export JENKINS_TRUSTY_IMAGE_TYPE="dev"
    suffix:
        # TODO(wonderfly): For Trusty, we currently only run CI and slow tests.
        # More test coverage under way.
        - 'master':
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE with Trusty images in parallel on the master branch.'
            timeout: 30
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="e2e-gce-trusty-ci-master"
        - 'slow-master':
            description: 'Runs slow tests on GCE with Trusty images, sequentially on the master branch.'
            timeout: 60
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="e2e-gce-trusty-ci-master-slow"
        - 'serial-master':
            description: 'Run [Serial], [Disruptive], tests on GCE, with Trusty images.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="e2e-gce-trusty-ci-serial"
    jobs:
        - 'kubernetes-e2e-gce-trusty-ci-{suffix}'

- project:
    name: kubernetes-e2e-gce-trusty-ci-1-2
    trigger-job: 'kubernetes-build-1.2'
    test-owner: 'wonderfly@google.com'
    emails: 'wonderfly@google.com,qzheng@google.com'
    provider-env: |
        {gce-provider-env}
        export JENKINS_PUBLISHED_VERSION="ci/latest-1.2"
        export JENKINS_TRUSTY_IMAGE_TYPE="dev"
    suffix:
        # TODO(wonderfly): For Trusty, we currently only run CI and slow tests.
        # More test coverage under way.
        - 'release-1.2':
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE with Trusty images in parallel on the release-1.2 branch.'
            timeout: 30
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="e2e-gce-trusty-ci-1-2"
        - 'slow-release-1.2':
            description: 'Runs slow tests on GCE with Trusty images, sequentially on the release-1.2 branch.'
            timeout: 60
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="e2e-gce-trusty-ci-slow-1-2"
        - 'serial-release-1.2':
            description: 'Run [Serial], [Disruptive], tests on GCE, with Trusty images, on the release-1.2 branch.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="e2e-gce-trusty-ci-serial-1-2"
    jobs:
        - 'kubernetes-e2e-gce-trusty-ci-{suffix}'

# Template for e2e test jobs that run on GCE with a released k8s version and
# Trusty's continuous builds (dev and beta only).
- job-template:
    name: 'kubernetes-e2e-gce-trusty-{suffix}'
    <<: *e2e_job_defaults
    node: '{jenkins_node}'
    triggers:
        - timed: 'H H/8 * * *'
    publishers:
        - e2e-publishers:
            recipients: '{emails}'
        - description-setter:
            regexp: KUBE_GCE_MASTER_IMAGE=(.*)
        - groovy-postbuild:
            script: |
                def trustyImageMatcher = manager.getLogMatcher("KUBE_GCE_MASTER_IMAGE=(.*)")
                if(trustyImageMatcher?.matches()) manager.addShortText("<b>Trusty Image: " + trustyImageMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
                def k8sVersionMatcher = manager.getLogMatcher("Using\\spublished\\sversion\\s(.*)\\s\\(from.*")
                if(k8sVersionMatcher?.matches()) manager.addShortText("<br><b>Kubernetes version: " + k8sVersionMatcher.group(1) + "</b>", "grey", "white", "0px", "white")

- project:
    name: kubernetes-e2e-gce-trusty-dev
    test-owner: 'wonderfly@google.com'
    branch: 'release-1.2'
    emails: 'wonderfly@google.com,qzheng@google.com'
    provider-env: |
        {gce-provider-env}
        export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
        export JENKINS_TRUSTY_IMAGE_TYPE="dev"
    suffix:
        - 'dev-release':
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE with the latest Trusty build and the latest k8s 1.2 release.'
            timeout: 30
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-e2e-gce-trusty-dev"
        - 'dev-slow':
            description: 'Run slow E2E tests on GCE with the latest Trusty build with the latest k8s 1.2 release.'
            timeout: 60
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-e2e-gce-trusty-dev-slow"
        - 'dev-serial':
            description: 'Run [Serial], [Disruptive], tests on GCE, with Trusty dev images and the latest k8s 1.2 release.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="e2e-gce-trusty-dev-serial"
    jobs:
        - 'kubernetes-e2e-gce-trusty-{suffix}'

- project:
    name: kubernetes-e2e-gce-trusty-beta
    test-owner: 'wonderfly@google.com'
    emails: 'wonderfly@google.com,qzheng@google.com'
    provider-env: |
        {gce-provider-env}
        export JENKINS_PUBLISHED_VERSION="release/stable-1.2"
        export JENKINS_TRUSTY_IMAGE_TYPE="beta"
    suffix:
        - 'beta-release':
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE with the latest Trusty beta build and the latest k8s 1.2 release.'
            timeout: 30
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-e2e-gce-trusty-beta"
        - 'beta-slow':
            description: 'Run slow E2E tests on GCE with the latest Trusty beta build with the latest k8s 1.2 release.'
            timeout: 60
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Slow\] \
                                         --ginkgo.skip=\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export PROJECT="k8s-e2e-gce-trusty-beta-slow"
        - 'beta-serial':
            description: 'Run [Serial], [Disruptive], tests on GCE, with Trusty beta images and the latest k8s 1.2 release.'
            timeout: 300
            job-env: |
                export GINKGO_TEST_ARGS="--ginkgo.focus=\[Serial\]|\[Disruptive\] \
                                         --ginkgo.skip=\[Flaky\]|\[Feature:.+\]"
                export PROJECT="e2e-gce-trusty-beta-serial"
    jobs:
        - 'kubernetes-e2e-gce-trusty-{suffix}'

# Template for e2e test jobs that run on GCE with a released k8s version and
# Trusty's continuous builds (stable only works with k8s 1.1).
- job-template:
    name: 'kubernetes-e2e-gce-trusty-stable-{suffix}'
    <<: *e2e_job_defaults
    node: '{jenkins_node}'
    triggers:
        # Trusty stable images are built once per day.
        - timed: '@daily'
    publishers:
        - e2e-publishers:
            recipients: '{emails}'
        - description-setter:
            # In 1.1, only nodes run Trusty.
            regexp: KUBE_GCE_MINION_IMAGE=(.*)
        - groovy-postbuild:
            script: |
                def trustyImageMatcher = manager.getLogMatcher("KUBE_GCE_MINION_IMAGE=(.*)")
                if(trustyImageMatcher?.matches()) manager.addShortText("<b>Trusty Image: " + trustyImageMatcher.group(1) + "</b>", "grey", "white", "0px", "white")
                def k8sVersionMatcher = manager.getLogMatcher("Using\\spublished\\sversion\\s(.*)\\s\\(from.*")
                if(k8sVersionMatcher?.matches()) manager.addShortText("<br><b>Kubernetes version: " + k8sVersionMatcher.group(1) + "</b>", "grey", "white", "0px", "white")

- project:
    name: kubernetes-e2e-gce-trusty-stable
    test-owner: 'wonderfly@google.com'
    branch: 'release-1.1'
    emails: 'wonderfly@google.com,qzheng@google.com'
    jenkins_node: 'master'
    runner: '{old-runner-1-1}'
    post-env: ''
    suffix:
        - 'release':
            # Broken as it pins to the latest k8s release, which is broken by https://github.com/kubernetes/kubernetes/issues/25153
            disable_job: true
            description: 'Runs all non-slow, non-serial, non-flaky, tests on GCE with the latest Trusty stable build and the latest k8s 1.1 release.'
            timeout: 150
        - 'slow':
            # Broken as it pins to the latest k8s release, which is broken by https://github.com/kubernetes/kubernetes/issues/25153
            disable_job: true
            description: 'Run slow E2E tests on GCE with the latest Trusty stable build with the latest k8s 1.1 release.'
            timeout: 270
    jobs:
        - 'kubernetes-e2e-gce-trusty-stable-{suffix}'

# Jobs that run e2e tests on GKE with Trusty as node image on the release-1.2
# branch. Note that the variable "E2E_NAME" in all following jobs are set to
# have the "-trusty" suffix, which is required to start a GKE cluster with
# Trusty images. The variable "KUBE_OS_DISTRIBUTION" is set to "trusty" so that
# the OS dependendent test cases will use Trusty in their assertions.
- project:
    name: kubernetes-e2e-gke-trusty
    trigger-job: 'kubernetes-build-1.2'
    test-owner: 'wonderfly@google.com'
    provider-env: |
        {gke-provider-env}
    emails: 'wonderfly@google.com,qzheng@google.com'
    suffix:
        - 'gke-trusty-test':
            description: 'Run E2E tests on GKE test endpoint.'
            timeout: 480
            job-env: |
                export PROJECT="kubekins-e2e-gke-trusty-test"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export E2E_NAME="gke-e2e-test-trusty"
                export KUBE_OS_DISTRIBUTION="trusty"
        - 'gke-trusty-subnet':
            description: 'Run E2E tests on GKE test endpoint in a subnet.'
            timeout: 480
            job-env: |
                # Subnetwork "jkns-gke-e2e-subnet-trusty" is manually created -
                # if deleted, it will need to be recreated via
                # `gcloud alpha compute networks create jkns-gke-e2e-subnet-trusty --mode auto`
                export PROJECT="k8s-e2e-gke-trusty-subnet"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export E2E_NAME="gke-e2e-subnet-trusty"
                export KUBE_OS_DISTRIBUTION="trusty"
        - 'gke-trusty-staging':
            description: 'Run E2E tests on GKE staging endpoint.'
            timeout: 480
            job-env: |
                export PROJECT="e2e-gke-trusty-staging"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER="https://staging-container.sandbox.googleapis.com/"
                export E2E_NAME="gke-e2e-staging-trusty"
                export KUBE_OS_DISTRIBUTION="trusty"
        - 'gke-trusty-staging-parallel':
            description: 'Run E2E tests on GKE staging endpoint in parallel.'
            timeout: 80
            job-env: |
                export PROJECT="e2e-gke-trusty-staging-p"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export CLOUDSDK_API_ENDPOINT_OVERRIDES_CONTAINER="https://staging-container.sandbox.googleapis.com/"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export E2E_NAME="gke-e2e-staging-pa-trusty"
                export KUBE_OS_DISTRIBUTION="trusty"
        - 'gke-trusty-prod':
            # Failing constantly due to a known issue (tracked internally).
            disable_job: true
            description: 'Run E2E tests on GKE prod endpoint.'
            timeout: 480
            job-env: |
                export PROJECT="kubekins-e2e-gke-trusty-prod"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export KUBE_GCE_ZONE="asia-east1-b"
                export E2E_NAME="gke-e2e-prod-trusty"
                export KUBE_OS_DISTRIBUTION="trusty"
        - 'gke-trusty-prod-parallel':
            # Failing constantly due to a known issue (tracked internally).
            disable_job: true
            description: 'Run E2E tests on GKE prod endpoint in parallel.'
            timeout: 80
            job-env: |
                export PROJECT="e2e-gke-trusty-prod-p"
                export CLOUDSDK_BUCKET="gs://cloud-sdk-testing/rc"
                export JENKINS_USE_SERVER_VERSION="y"
                export GINKGO_TEST_ARGS="--ginkgo.skip=\[Slow\]|\[Serial\]|\[Disruptive\]|\[Flaky\]|\[Feature:.+\]"
                export GINKGO_PARALLEL="y"
                export KUBE_GCE_ZONE="asia-east1-b"
                export E2E_NAME="gke-e2e-prod-pa-trusty"
                export KUBE_OS_DISTRIBUTION="trusty"
    jobs:
        - 'kubernetes-e2e-{suffix}'

# End of Trusty jobs

- job-group:
    name: 'kubernetes-e2e-{provider}-{version-old}-{version-new}'
    trigger-job: 'kubernetes-build'
    test-owner: 'ihmccreery'
    emails: 'ihmccreery@google.com'
    jobs:
        - 'kubernetes-e2e-{suffix}':
            suffix: '{provider}-{version-old}-{version-new}-kubectl-skew'
            description: 'Deploys a cluster at v{version-old} and runs the Kubectl tests with v{version-new} kubectl.'
            timeout: 120
            job-env: |
                export PROJECT="kube-gke-upg-{version-infix}-ctl-skew"
                export JENKINS_PUBLISHED_VERSION="ci/latest-{version-old}"
                export GINKGO_TEST_ARGS="--ginkgo.focus=Kubectl"
                export JENKINS_PUBLISHED_SKEW_VERSION="ci/latest-{version-new}"
                export JENKINS_USE_SKEW_KUBECTL="true"
                export GINKGO_PARALLEL="y"
                export E2E_OPT="--check_version_skew=false"
                {version-env}
        - 'kubernetes-e2e-{suffix}':
            suffix: '{provider}-{version-old}-{version-new}-upgrade-master'
            step: 'upgrade-master'
            description: 'Deploys a cluster at v{version-old}, upgrades the master to v{version-new}, and runs the v{version-old} tests.'
            timeout: 300
            job-env: |
                export PROJECT="kube-gke-upg-{version-infix}-upg-mas"
                export JENKINS_PUBLISHED_VERSION="ci/latest-{version-old}"
                export E2E_UPGRADE_TEST="true"
                export JENKINS_PUBLISHED_SKEW_VERSION="ci/latest-{version-new}"
                export GINKGO_UPGRADE_TEST_ARGS="--ginkgo.focus=\[Feature:MasterUpgrade\] --upgrade-target=ci/latest-{version-new}"
                export E2E_OPT="--check_version_skew=false"
                # Set legacy skip list, only when testing old version
                # TODO remove when we no longer care about v1.1
                {legacy-ginkgo-test-args-env}
                {version-env}
        - 'kubernetes-e2e-{suffix}':
            suffix: '{provider}-{version-old}-{version-new}-upgrade-cluster'
            description: 'Deploys a cluster at v{version-old}, upgrades the cluster to v{version-new}, and runs the v{version-old} tests.'
            timeout: 300
            job-env: |
                export PROJECT="kube-gke-upg-{version-infix}-upg-clu"
                export JENKINS_PUBLISHED_VERSION="ci/latest-{version-old}"
                export E2E_UPGRADE_TEST="true"
                export JENKINS_PUBLISHED_SKEW_VERSION="ci/latest-{version-new}"
                export GINKGO_UPGRADE_TEST_ARGS="--ginkgo.focus=\[Feature:ClusterUpgrade\] --upgrade-target=ci/latest-{version-new}"
                export E2E_OPT="--check_version_skew=false"
                # Set legacy skip list, only when testing old version
                # TODO remove when we no longer care about v1.1
                {legacy-ginkgo-test-args-env}
                {version-env}
        - 'kubernetes-e2e-{suffix}':
            suffix: '{provider}-{version-old}-{version-new}-upgrade-cluster-new'
            description: 'Deploys a cluster at v{version-old}, upgrades the cluster to v{version-new}, and runs the v{version-new} tests.'
            timeout: 300
            job-env: |
                export PROJECT="kube-gke-upg-{version-infix}-upg-clu-n"
                export JENKINS_PUBLISHED_VERSION="ci/latest-{version-old}"
                export E2E_UPGRADE_TEST="true"
                export JENKINS_PUBLISHED_SKEW_VERSION="ci/latest-{version-new}"
                export GINKGO_UPGRADE_TEST_ARGS="--ginkgo.focus=\[Feature:ClusterUpgrade\] --upgrade-target=ci/latest-{version-new}"
                export JENKINS_USE_SKEW_TESTS="true"
                export E2E_OPT="--check_version_skew=false"
                {version-env}

- project:
    name: kubernetes-e2e-upgrades-gke
    provider: 'gke'
    provider-env: '{gke-provider-env}'
    jobs:
        - 'kubernetes-e2e-{provider}-{version-old}-{version-new}':
            version-old: '1.0'
            version-new: '1.2'
            version-infix: '1-0-1-2'
            version-env: |
                # In v1.1 and below, NUM_MINIONS defaults to 2, so we have to override to 3 here.  NUM_MINIONS
                # was changed to NUM_NODES in v1.2, but we don't need to override for v1.2 and above.
                export NUM_MINIONS=3
                # Similarly, in v1.1 and below, MINION_SIZE defaults to 'n1-standard-1', so we need to
                # override it here (specifically for HPA tests).  MINION_SIZE was changed to
                # NODE_SIZE in v1.2, but we don't need to override for v1.2 and above.
                export MINION_SIZE='n1-standard-2'
            legacy-ginkgo-test-args-env: |
                # XXX This is a hack to run only the tests we care about, without importing all of
                # the skip list vars from the v1.0 e2e.sh.
                export GINKGO_TEST_ARGS="--ginkgo.skip=Skipped|Restart\sshould\srestart\sall\snodes|Example|Reboot|ServiceLoadBalancer|DaemonRestart\sController\sManager|Daemon\sset\sshould\srun\sand\sstop\scomplex\sdaemon|Resource\susage\sof\ssystem\scontainers|allows\sscheduling\sof\spods\son\sa\sminion\safter\sit\srejoins\sthe\scluster"
        - 'kubernetes-e2e-{provider}-{version-old}-{version-new}':
            version-old: '1.1'
            version-new: '1.2'
            version-infix: '1-1-1-2'
            version-env: |
                # In v1.1 and below, NUM_MINIONS defaults to 2, so we have to override to 3 here.  NUM_MINIONS
                # was changed to NUM_NODES in v1.2, but we don't need to override for v1.2 and above.
                export NUM_MINIONS=3
                # Similarly, in v1.1 and below, MINION_SIZE defaults to 'n1-standard-1', so we need to
                # override it here (specifically for HPA tests).  MINION_SIZE was changed to
                # NODE_SIZE in v1.2, but we don't need to override for v1.2 and above.
                export MINION_SIZE='n1-standard-2'
            legacy-ginkgo-test-args-env: |
                # XXX This is a hack to run only the tests we care about, without importing all of
                # the skip list vars from the v1.1 e2e.sh.
                export GINKGO_TEST_ARGS="--ginkgo.skip=Autoscaling\sSuite|resource\susage\stracking|Nodes|Etcd\sFailure|MasterCerts|experimental\sresource\susage\stracking|ServiceLoadBalancer|Shell|Daemon\sset|Deployment|Skipped|Restart\sshould\srestart\sall\snodes|Example|Reboot|ServiceLoadBalancer|DaemonRestart\sController\sManager|Daemon\sset\sshould\srun\sand\sstop\scomplex\sdaemon|Resource\susage\sof\ssystem\scontainers|allows\sscheduling\sof\spods\son\sa\sminion\safter\sit\srejoins\sthe\scluster"
        - 'kubernetes-e2e-{provider}-{version-old}-{version-new}':
            version-old: '1.1'
            version-new: '1.3'
            version-infix: '1-1-1-3'
            version-env: |
                # In v1.1 and below, NUM_MINIONS defaults to 2, so we have to override to 3 here.  NUM_MINIONS
                # was changed to NUM_NODES in v1.2, but we don't need to override for v1.2 and above.
                export NUM_MINIONS=3
                # Similarly, in v1.1 and below, MINION_SIZE defaults to 'n1-standard-1', so we need to
                # override it here (specifically for HPA tests).  MINION_SIZE was changed to
                # NODE_SIZE in v1.2, but we don't need to override for v1.2 and above.
                export MINION_SIZE='n1-standard-2'
            legacy-ginkgo-test-args-env: |
                # XXX This is a hack to run only the tests we care about, without importing all of
                # the skip list vars from the v1.1 e2e.sh.
                export GINKGO_TEST_ARGS="--ginkgo.skip=Autoscaling\sSuite|resource\susage\stracking|Nodes|Etcd\sFailure|MasterCerts|experimental\sresource\susage\stracking|ServiceLoadBalancer|Shell|Daemon\sset|Deployment|Skipped|Restart\sshould\srestart\sall\snodes|Example|Reboot|ServiceLoadBalancer|DaemonRestart\sController\sManager|Daemon\sset\sshould\srun\sand\sstop\scomplex\sdaemon|Resource\susage\sof\ssystem\scontainers|allows\sscheduling\sof\spods\son\sa\sminion\safter\sit\srejoins\sthe\scluster"
        - 'kubernetes-e2e-{provider}-{version-old}-{version-new}':
            version-old: '1.2'
            version-new: '1.3'
            version-infix: '1-2-1-3'
            version-env: ''
            legacy-ginkgo-test-args-env: ''
